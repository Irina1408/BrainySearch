@{
    ViewBag.Title = "Search";
}

@section styles{
    <link href="~/Content/keywords.css" rel="stylesheet" type="text/css" />
}

<h1> Search info</h1>
<hr />
<div class="row">
    @*<gcse:search></gcse:search>*@
    <div class="col-sm-6 col-md-6">
        <div>
            @* Lecture theme *@
            <div class="form-group">
                @*<label class='control-label' style="margin-top: 10px; margin-left: 27px">Lecture theme</label>*@
                <h3 class='control-label' style="margin-top: 10px; margin-left: 15px">Lecture theme</h3>
            </div>
            <div class="form-group">
                <div class="col-md-6">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Lecture theme" id="lectureTheme">
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-default" id="search">Search</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-md-5">
        @* Key words *@
        <div class="row">
            <div class="form-group">
                <h3 class='control-label' style="margin-top: 10px; margin-left: 15px">Key words</h3>
            </div>
            <div class="form-group">
                <div class="col-md-6">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Key word" id="keyWord">
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-default" id="addKeyWord">Add</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group" style="margin-top: 10px; margin-left: 15px">
                <div id="keyWordsContainer" class="keyword-group" role="group">
                </div>
            </div>
        </div>
    </div>
</div>

@* show search result line *@
<div id="searching" style="display: none;">
    <hr style="margin-top: 10px;" />
</div>

@* Label of loading process *@
<div id="searchingStarted" style="display: none;">
    <h3 class='control-label' style="margin-top: 10px; margin-left: 15px">Searching...</h3>
</div>

@* show search result *@
<div id="searchResultContainer" style="display: none;">
    <div class="panel panel-default" style="margin-top: 5px;">
        <div class="panel-heading">Search result</div>
        <table class="table">
            <tbody id="searchResultItems"></tbody>
        </table>
    </div>
</div>

@section Scripts{
    @*<script src="~/Scripts/jquery-3.2.1.min.js"></script>*@

    <script type="text/javascript">

        var keyWordNumber = 1;
        var keyWordArray = new Array();

        function removeKeyWord() {
            var targetId = event.target.id;
            var val = event.target.text;
            var valIndex = keyWordArray.indexOf(val);

            console.log('button id', targetId);
            console.log('val', val);
            console.log('valIndex', valIndex);

            // remove from list
            keyWordArray.splice(valIndex, 1);
            // remove control
            $("#" + targetId).remove();
        }

        $(document).ready(function () {


            $('#addKeyWord').click(function () {
                var keyWordText = $('#keyWord').val();
                if (keyWordText != null && keyWordText != "")
                {
                    // add to list
                    keyWordArray.push(keyWordText);
                    
                    // add new control
                    var newKeyWord = "<a class='keyword-active remove-icon' id='keyWord" + keyWordNumber + "' onclick='removeKeyWord()'>" + keyWordText + "</a>";
                    $(newKeyWord).appendTo('#keyWordsContainer');

                    // clear value
                    $('#keyWord').val("");

                    // update key word number for next key word
                    keyWordNumber += 1;
                }
            });

            // search Button click handler
            $('#search').click(function () {
                // hide tbody searchResultContainer
                $("#searchResultContainer").css('display', 'none');
                // show separator line
                $("#searching").css('display', 'block');
                // show process loading label
                $("#searchingStarted").css('display', 'block');

                var d = {};
                d.lectureTheme = $('#lectureTheme').val();
                d.keyWords = keyWordArray;
                console.log("array", keyWordArray);
                console.log("data", d);

                $.getJSON('@Url.Action("Search", "Home")', $.param(d, true), function (data) {
                    console.log('ajax data', data);
                        writeSearchResult(data);
                });
            });

            // show search result
            function writeSearchResult(data) {
                // clear div searchResultItems
                $("#searchResultItems").empty();

                for (var i = 0; i < data.length; i++) {
                    var newRow = "<tr>"
                                    + "<td width='3%'>"
                                        + "<input type='checkbox' width='min-content' checked=" + data[i].AddToLecture + " />"
                                    + "</td>"
                                    + "<td>"
                                        + "<label class='control-label'>" + data[i].Title + "</label>"
                                        + "<label class='control-label' style='font-weight: normal;'>" + data[i].Text + "</label>"
                                    + "</td>"
                                    + "<td>"
                                        + "<a style='word-wrap:break-word' href=" + data[i].SourceLink + ">" + data[i].ShortLink + "</a>"
                                    + "</td>"
                                    + "</tr>";
                    $(newRow).appendTo('#searchResultItems');
                }

                // hide process loading label
                $("#searchingStarted").css('display', 'none');
                // show tbody searchResultContainer
                $("#searchResultContainer").css('display', 'block');
            }
        });
    </script>
}

